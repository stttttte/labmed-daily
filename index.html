<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>LabMed Daily Â· æ£€éªŒåŒ»å­¦è®ºæ–‡æ—¥æŠ¥</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ§¬</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=JetBrains+Mono:wght@300;400;500&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#f8f7f4;--sf:#fff;--bd:#ddd8cf;--tx:#1c1917;--txd:#57534e;--txl:#a8a29e;--ac:#b91c1c;--ac2:#166534;--gold:#a16207}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans SC','Cormorant Garamond',serif;background:var(--bg);color:var(--tx);-webkit-font-smoothing:antialiased;min-height:100vh}

/* Header */
.hd{text-align:center;padding:28px 20px 24px;background:var(--sf);border-bottom:2px solid var(--tx)}
.hd h1{font-family:'Cormorant Garamond',serif;font-size:clamp(34px,9vw,52px);font-weight:700;letter-spacing:-2px;line-height:1}
.hd .sub{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--txl);letter-spacing:4px;text-transform:uppercase;margin-top:5px}
.hd .date{font-family:'Cormorant Garamond',serif;font-style:italic;font-size:14px;color:var(--txd);margin-top:8px}
.hd .meta{display:flex;justify-content:center;gap:20px;margin-top:10px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--txl)}
.hd .meta b{color:var(--ac);font-size:14px;font-weight:600}

/* Status bar */
.bar{padding:7px 16px;text-align:center;font-family:'JetBrains Mono',monospace;font-size:11px;border-bottom:1px solid var(--bd)}
.bar.ok{background:#f0fdf4;color:var(--ac2)}.bar.warn{background:#fffbeb;color:var(--gold)}.bar.load{background:#f8f7f4;color:var(--txl)}
.pbar{height:2px;background:var(--bd);border-radius:1px;margin-bottom:5px;overflow:hidden}
.pfill{height:100%;background:var(--ac);border-radius:1px;transition:width .4s}

/* Container */
.wrap{max-width:900px;margin:0 auto;padding:0 16px}

/* Controls */
.ctl{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;padding:14px 0;border-bottom:1px solid var(--bd)}
.fg{display:flex;gap:4px;flex-wrap:wrap}
.ft{font-family:'JetBrains Mono',monospace;font-size:10px;padding:4px 11px;border:1px solid var(--bd);border-radius:18px;background:var(--sf);color:var(--txd);cursor:pointer;transition:.15s;user-select:none;white-space:nowrap}
.ft:hover{border-color:var(--txd)}.ft.on{background:var(--tx);color:#fff;border-color:var(--tx)}
.rb{font-family:'JetBrains Mono',monospace;font-size:10px;padding:5px 14px;border:1px solid var(--ac);border-radius:5px;background:var(--sf);color:var(--ac);cursor:pointer;white-space:nowrap}
.rb:hover{background:var(--ac);color:#fff}.rb:disabled{opacity:.35;cursor:not-allowed}

/* Cards */
.dl{font-family:'Cormorant Garamond',serif;font-size:17px;font-weight:600;margin:24px 0 10px;padding-bottom:5px;border-bottom:1px solid var(--bd)}
.cd{display:block;text-decoration:none;color:inherit;background:var(--sf);border:1px solid var(--bd);border-radius:8px;padding:14px 16px;margin-bottom:7px;transition:.2s}
.cd:hover{box-shadow:0 3px 16px rgba(0,0,0,.06);transform:translateY(-1px)}
.cd:active{transform:scale(.998)}
.bg{display:inline-block;font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:500;text-transform:uppercase;letter-spacing:1.5px;padding:2px 7px;border-radius:3px;margin-bottom:5px}
.bg-cc{background:#fef3c7;color:#92400e}.bg-pm{background:#fae8ff;color:#7e22ce}.bg-oa{background:#ccfbf1;color:#0f766e}
.ct{font-family:'Cormorant Garamond','Noto Sans SC',serif;font-size:16px;font-weight:600;line-height:1.45;margin-bottom:3px}
.ca{font-size:11px;color:var(--txd);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cab{font-size:12px;color:var(--txl);line-height:1.6;margin-top:4px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.cf{display:flex;gap:10px;margin-top:5px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--txl);flex-wrap:wrap}
.papers{padding-bottom:70px}

/* Loading */
.la{text-align:center;padding:50px 16px}.la .dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--ac);margin:0 3px;animation:bo 1s ease-in-out infinite}
.la .dot:nth-child(2){animation-delay:.12s}.la .dot:nth-child(3){animation-delay:.24s}
@keyframes bo{0%,80%,100%{transform:scale(.5);opacity:.3}40%{transform:scale(1);opacity:1}}
.la .lt{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--txl);margin-top:12px}
.chips{display:flex;flex-wrap:wrap;gap:4px;justify-content:center;margin-top:10px}
.chip{font-family:'JetBrains Mono',monospace;font-size:9px;padding:2px 8px;border-radius:4px}
.chip.w{background:#f5f5f4;color:var(--txl)}.chip.g{background:#f0fdf4;color:var(--ac2)}.chip.r{background:#fef2f2;color:var(--ac)}

/* Logs */
.logwrap{margin:10px 0}
.logbtn{font-family:'JetBrains Mono',monospace;font-size:10px;padding:3px 10px;border:1px solid var(--bd);border-radius:5px;background:var(--sf);color:var(--txl);cursor:pointer}
.logbox{margin-top:6px;padding:10px;background:#1e1e2e;border-radius:7px;max-height:160px;overflow:auto;font-family:'JetBrains Mono',monospace;font-size:10px;line-height:1.5;color:#cdd6f4;display:none}
.logbox.open{display:block}
.logbox .err{color:#f38ba8}.logbox .ok{color:#a6e3a1}.logbox .wrn{color:#f9e2af}

.empty{text-align:center;padding:50px 16px;color:var(--txl);font-family:'JetBrains Mono',monospace;font-size:12px}
@media(max-width:500px){.ct{font-size:15px}.cd{padding:12px 14px}.ctl{flex-direction:column;align-items:flex-start}}
</style>
</head>
<body>

<div class="hd">
  <h1>LabMed Daily</h1>
  <div class="sub">æ£€éªŒåŒ»å­¦è®ºæ–‡æ—¥æŠ¥</div>
  <div class="date" id="dt"></div>
  <div class="meta"><span><b id="tc">0</b> ç¯‡è®ºæ–‡</span><span><b id="sc">0</b> æ¥æº</span></div>
</div>
<div class="bar load" id="bar">
  <div class="pbar"><div class="pfill" id="pfill" style="width:0%"></div></div>
  <span id="bartxt">æ­£åœ¨è·å–è®ºæ–‡...</span>
</div>

<div class="wrap">
  <div class="ctl">
    <div class="fg" id="fg"></div>
    <button class="rb" id="rbtn" onclick="loadAll()" disabled>âŸ³ åˆ·æ–°</button>
  </div>
  <div class="logwrap">
    <button class="logbtn" onclick="toggleLog()"><span id="la">â–¶</span> è°ƒè¯•æ—¥å¿— (<span id="lc">0</span>)</button>
    <div class="logbox" id="logbox"></div>
  </div>
  <div class="papers" id="pa"></div>
</div>

<script>
// =============================================
// LabMed Daily â€” GitHub Pages å®æ—¶ç‰ˆ
// éƒ¨ç½²: ä¸Šä¼ æ­¤æ–‡ä»¶ä¸º index.html åˆ° GitHub Pages
// =============================================

const SOURCES = [
  {id:'cc', name:'Clinical Chemistry', bg:'bg-cc'},
  {id:'pm', name:'PubMed', bg:'bg-pm'},
  {id:'oa', name:'OpenAlex', bg:'bg-oa'},
];
const BDGMAP = {}; SOURCES.forEach(s => BDGMAP[s.id] = s);

// --- æ—¥å¿— ---
let logs = [];
function log(msg) {
  logs.push({t: new Date().toLocaleTimeString(), m: msg});
  document.getElementById('lc').textContent = logs.length;
  const box = document.getElementById('logbox');
  const cls = msg.includes('âŒ') ? 'err' : msg.includes('âœ…') ? 'ok' : msg.includes('âš ') ? 'wrn' : '';
  box.innerHTML += `<div class="${cls}">${logs[logs.length-1].t} ${msg}</div>`;
  box.scrollTop = box.scrollHeight;
}
function toggleLog() {
  const b = document.getElementById('logbox');
  b.classList.toggle('open');
  document.getElementById('la').textContent = b.classList.contains('open') ? 'â–¼' : 'â–¶';
}

// --- å®‰å…¨ fetch (è¶…æ—¶å¤„ç†) ---
function safeFetch(url, ms = 15000) {
  const ctrl = new AbortController();
  const timer = setTimeout(() => ctrl.abort(), ms);
  return fetch(url, {signal: ctrl.signal}).then(r => {clearTimeout(timer); return r;}).catch(e => {clearTimeout(timer); throw e;});
}

// --- CORS ä»£ç† (ç”¨äº OUP RSS) ---
const PROXIES = [
  u => 'https://api.allorigins.win/raw?url=' + encodeURIComponent(u),
  u => 'https://corsproxy.io/?' + encodeURIComponent(u),
  u => 'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(u),
];

async function fetchViaProxy(url) {
  for (let i = 0; i < PROXIES.length; i++) {
    const pu = PROXIES[i](url);
    const name = ['allorigins','corsproxy','codetabs'][i];
    try {
      log('ğŸ”„ ä»£ç† ' + name + '...');
      const r = await safeFetch(pu, 12000);
      if (r.ok) {
        const txt = await r.text();
        if (txt.length > 100) { log('âœ… ' + name + ' æˆåŠŸ (' + txt.length + 'B)'); return txt; }
      }
      log('âš ï¸ ' + name + ' è¿”å›æ— æ•ˆ');
    } catch(e) { log('âŒ ' + name + ': ' + e.message); }
  }
  return null;
}

// --- æ•°æ®æ¥æº: Clinical Chemistry RSS ---
function stripHtml(s) { if (!s) return ''; const d = document.createElement('div'); d.innerHTML = s; return d.textContent.replace(/\s+/g,' ').trim(); }

async function fetchClinChem() {
  const feeds = [
    {l:'Advance', u:'https://academic.oup.com/rss/site_6246/advanceAccess_4044.xml'},
    {l:'Current', u:'https://academic.oup.com/rss/site_6246/4044.xml'},
  ];
  const all = [], seen = new Set();
  for (const feed of feeds) {
    log('ğŸ“¡ è·å– ' + feed.l + ' RSS...');
    const xml = await fetchViaProxy(feed.u);
    if (!xml || !xml.includes('<item')) { log('âš ï¸ ' + feed.l + ': æ— æœ‰æ•ˆ RSS'); continue; }
    try {
      const doc = new DOMParser().parseFromString(xml, 'text/xml');
      if (doc.querySelector('parsererror')) { log('âš ï¸ XML è§£æé”™è¯¯'); continue; }
      const items = doc.querySelectorAll('item');
      let cnt = 0;
      items.forEach(it => {
        const title = (it.querySelector('title')?.textContent||'').trim();
        let link = (it.querySelector('link')?.textContent||'').trim().replace('?rss=1','');
        const pub = it.querySelector('pubDate')?.textContent||'';
        const desc = it.querySelector('description')?.textContent||'';
        if (!title || seen.has(title.toLowerCase())) return;
        seen.add(title.toLowerCase());
        let date = ''; try { date = new Date(pub).toISOString().slice(0,10); } catch{}
        let ab = stripHtml(desc); if (ab.length > 400) ab = ab.slice(0,400) + '...';
        all.push({sid:'cc',s:'Clinical Chemistry',title,url:link,authors:'',date,journal:'Clinical Chemistry ('+feed.l+')',abstract:ab});
        cnt++;
      });
      log('âœ… ' + feed.l + ': ' + cnt + ' ç¯‡');
    } catch(e) { log('âŒ RSS è§£æ: ' + e.message); }
  }
  return all;
}

// --- æ•°æ®æ¥æº: PubMed (CORS âœ“) ---
const LM_QUERIES = [
  'clinical laboratory medicine','clinical chemistry biomarker','hematology laboratory testing',
  'molecular diagnostics pathology','immunoassay clinical','point-of-care testing',
  'flow cytometry clinical','mass spectrometry clinical laboratory',
  'clinical microbiology diagnostics','tumor marker diagnostics',
];
function pickQ(n) { return [...LM_QUERIES].sort(()=>Math.random()-.5).slice(0,n); }

async function fetchPubMed(query) {
  log('ğŸ” PubMed: ' + query);
  try {
    const sr = await safeFetch('https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&term='+encodeURIComponent(query)+'&retmax=5&sort=date&retmode=json', 10000);
    if (!sr.ok) { log('âŒ PubMed search HTTP '+sr.status); return []; }
    const sd = await sr.json();
    const ids = sd.esearchresult?.idlist || [];
    if (!ids.length) { log('âš ï¸ PubMed: 0 æ¡'); return []; }
    const sm = await safeFetch('https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&id='+ids.join(',')+'&retmode=json', 10000);
    if (!sm.ok) return [];
    const d = await sm.json();
    const ps = ids.map(id => {
      const it = d.result?.[id]; if (!it) return null;
      return {sid:'pm',s:'PubMed',title:it.title||'',authors:(it.authors||[]).map(a=>a.name).join(', '),date:it.pubdate||'',url:'https://pubmed.ncbi.nlm.nih.gov/'+id+'/',journal:it.source||'',abstract:''};
    }).filter(Boolean);
    log('âœ… PubMed "'+query+'": '+ps.length+'ç¯‡');
    return ps;
  } catch(e) { log('âŒ PubMed: '+e.message); return []; }
}

// --- æ•°æ®æ¥æº: OpenAlex (CORS âœ“) ---
async function fetchOpenAlex(query) {
  log('ğŸ” OpenAlex: ' + query);
  try {
    const r = await safeFetch('https://api.openalex.org/works?search='+encodeURIComponent(query)+'&per_page=5&sort=publication_date:desc&filter=type:article&mailto=labmed@example.com', 10000);
    if (!r.ok) { log('âŒ OpenAlex HTTP '+r.status); return []; }
    const d = await r.json();
    const ps = (d.results||[]).map(w => {
      let ab = '';
      if (w.abstract_inverted_index) { const ws=[]; for (const[word,pos] of Object.entries(w.abstract_inverted_index)) for(const p of pos) ws[p]=word; ab=ws.join(' '); }
      return {sid:'oa',s:'OpenAlex',title:w.title||'',authors:(w.authorships||[]).map(a=>a.author?.display_name).filter(Boolean).join(', '),date:w.publication_date||'',url:w.doi||w.id||'',journal:w.primary_location?.source?.display_name||'',abstract:ab};
    });
    log('âœ… OpenAlex "'+query+'": '+ps.length+'ç¯‡');
    return ps;
  } catch(e) { log('âŒ OpenAlex: '+e.message); return []; }
}

// --- ä¸»é€»è¾‘ ---
let allPapers = [], activeFilter = 'all';

async function loadAll() {
  const btn = document.getElementById('rbtn');
  btn.disabled = true; btn.textContent = 'åŠ è½½ä¸­...';
  allPapers = []; logs = [];
  document.getElementById('logbox').innerHTML = '';
  document.getElementById('lc').textContent = '0';
  setBar('load', 'æ­£åœ¨è·å–è®ºæ–‡...', 0);
  showLoading();

  const queries = pickQ(2);
  log('ğŸš€ å¼€å§‹åŠ è½½ï¼Œå…³é”®è¯: ' + queries.join(', '));

  const steps = 1 + queries.length * 2; // CC + PM*q + OA*q
  let done = 0;
  const progress = () => { done++; document.getElementById('pfill').style.width = Math.round(done/steps*100)+'%'; };

  // 1. Clinical Chemistry
  const cc = await fetchClinChem();
  allPapers.push(...cc);
  progress();
  renderPapers();

  // 2. PubMed
  for (const q of queries) {
    const pm = await fetchPubMed(q);
    allPapers.push(...pm);
    progress();
    renderPapers();
    await new Promise(r => setTimeout(r, 350));
  }

  // 3. OpenAlex
  for (const q of queries) {
    const oa = await fetchOpenAlex(q);
    allPapers.push(...oa);
    progress();
    renderPapers();
    await new Promise(r => setTimeout(r, 350));
  }

  // å®Œæˆ
  const u = getUnique('all');
  log('ğŸ åŠ è½½å®Œæˆï¼Œå…± ' + u.length + ' ç¯‡ï¼ˆå»é‡åï¼‰');
  if (u.length > 0) {
    setBar('ok', 'âœ… å…± ' + u.length + ' ç¯‡è®ºæ–‡ Â· ' + new Date().toLocaleTimeString('zh-CN'), 100);
  } else {
    setBar('warn', 'âš ï¸ æœªè·å–åˆ°è®ºæ–‡ï¼Œè¯·æŸ¥çœ‹è°ƒè¯•æ—¥å¿—', 100);
    document.getElementById('logbox').classList.add('open');
    document.getElementById('la').textContent = 'â–¼';
  }
  btn.disabled = false; btn.textContent = 'âŸ³ åˆ·æ–°';
  renderFilters();
  renderStats();
}

function setBar(cls, txt, pct) {
  const bar = document.getElementById('bar');
  bar.className = 'bar ' + cls;
  document.getElementById('bartxt').textContent = txt;
  if (pct !== undefined) document.getElementById('pfill').style.width = pct + '%';
}

function getUnique(f) {
  const seen = new Map();
  for (const p of allPapers) {
    const k = p.title.toLowerCase().replace(/[^a-z0-9\u4e00-\u9fff]/g,'').slice(0,80);
    if (k.length >= 5 && !seen.has(k)) seen.set(k, p);
  }
  let ps = [...seen.values()];
  if (f && f !== 'all') ps = ps.filter(p => p.sid === f);
  ps.sort((a,b) => (b.date||'0').localeCompare(a.date||'0'));
  return ps;
}

function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function fmtDate(d) {
  if (!d || d==='æœªçŸ¥æ—¥æœŸ') return d||'';
  try { const dt=new Date(d),t=new Date();t.setHours(0,0,0,0);const diff=Math.floor((t-dt)/864e5);
    if(diff===0) return 'ä»Šå¤© Â· '+d; if(diff===1) return 'æ˜¨å¤© Â· '+d; if(diff<7) return diff+'å¤©å‰ Â· '+d; return d;
  } catch { return d; }
}

function renderPapers() {
  const ps = getUnique(activeFilter);
  const area = document.getElementById('pa');
  if (!ps.length) { area.innerHTML = '<div class="empty">æš‚æ— è®ºæ–‡</div>'; return; }
  const g = new Map();
  for (const p of ps) { const d = p.date?.slice(0,10)||'æœªçŸ¥æ—¥æœŸ'; if (!g.has(d)) g.set(d,[]); g.get(d).push(p); }
  let h = '';
  for (const [date, list] of g) {
    h += '<div class="dl">' + fmtDate(date) + '</div>';
    for (const p of list) {
      const b = BDGMAP[p.sid] || BDGMAP.cc;
      h += '<a class="cd" href="'+esc(p.url||'#')+'" target="_blank" rel="noopener">' +
        '<span class="bg '+b.bg+'">'+esc(p.s)+'</span>' +
        '<div class="ct">'+esc(p.title)+'</div>' +
        (p.authors ? '<div class="ca">'+esc(p.authors)+'</div>' : '') +
        (p.abstract ? '<div class="cab">'+esc(p.abstract)+'</div>' : '') +
        '<div class="cf">'+(p.journal?'<span>ğŸ“– '+esc(p.journal)+'</span>':'')+(p.date?'<span>ğŸ“… '+esc(p.date)+'</span>':'')+'</div></a>';
    }
  }
  area.innerHTML = h;
}

function renderFilters() {
  const all = getUnique('all');
  const counts = {};
  all.forEach(p => counts[p.sid] = (counts[p.sid]||0)+1);
  const fg = document.getElementById('fg');
  let h = '<span class="ft'+(activeFilter==='all'?' on':'')+'" onclick="setF(\'all\')">å…¨éƒ¨ ('+all.length+')</span>';
  SOURCES.forEach(s => {
    const n = counts[s.id]||0; if (!n) return;
    h += '<span class="ft'+(activeFilter===s.id?' on':'')+'" onclick="setF(\''+s.id+'\')">'+s.name+' ('+n+')</span>';
  });
  fg.innerHTML = h;
}

function setF(f) { activeFilter = f; renderFilters(); renderPapers(); }

function renderStats() {
  const u = getUnique('all');
  document.getElementById('tc').textContent = u.length;
  document.getElementById('sc').textContent = new Set(u.map(p=>p.sid)).size;
}

function showLoading() {
  document.getElementById('pa').innerHTML = '<div class="la"><span class="dot"></span><span class="dot"></span><span class="dot"></span><div class="lt">æ­£åœ¨ä» 3 ä¸ªæ¥æºè·å–è®ºæ–‡...</div></div>';
}

// --- å¯åŠ¨ ---
document.getElementById('dt').textContent = new Date().toLocaleDateString('zh-CN', {year:'numeric',month:'long',day:'numeric',weekday:'long'});
loadAll();
</script>
</body>
</html>
