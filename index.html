<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>LabMed Daily ¬∑ Ê£ÄÈ™åÂåªÂ≠¶ËÆ∫ÊñáÊó•Êä•</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß¨</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=JetBrains+Mono:wght@300;400;500&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#f8f7f4;--sf:#fff;--bd:#ddd8cf;--tx:#1c1917;--txd:#57534e;--txl:#a8a29e;--ac:#b91c1c;--ac2:#166534;--gold:#a16207}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans SC','Cormorant Garamond',serif;background:var(--bg);color:var(--tx);-webkit-font-smoothing:antialiased;min-height:100vh}
.hd{text-align:center;padding:28px 20px 24px;background:var(--sf);border-bottom:2px solid var(--tx)}
.hd h1{font-family:'Cormorant Garamond',serif;font-size:clamp(34px,9vw,52px);font-weight:700;letter-spacing:-2px;line-height:1}
.hd .sub{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--txl);letter-spacing:4px;text-transform:uppercase;margin-top:5px}
.hd .date{font-family:'Cormorant Garamond',serif;font-style:italic;font-size:14px;color:var(--txd);margin-top:8px}
.hd .meta{display:flex;justify-content:center;gap:20px;margin-top:10px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--txl)}
.hd .meta b{color:var(--ac);font-size:14px;font-weight:600}
.bar{padding:7px 16px;text-align:center;font-family:'JetBrains Mono',monospace;font-size:11px;border-bottom:1px solid var(--bd)}
.bar.ok{background:#f0fdf4;color:var(--ac2)}.bar.warn{background:#fffbeb;color:var(--gold)}.bar.load{background:var(--bg);color:var(--txl)}
.pbar{height:2px;background:var(--bd);border-radius:1px;margin-bottom:5px;overflow:hidden}
.pfill{height:100%;background:var(--ac);border-radius:1px;transition:width .4s}
.wrap{max-width:900px;margin:0 auto;padding:0 16px}
.ctl{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;padding:14px 0;border-bottom:1px solid var(--bd)}
.fg{display:flex;gap:4px;flex-wrap:wrap}
.ft{font-family:'JetBrains Mono',monospace;font-size:10px;padding:4px 11px;border:1px solid var(--bd);border-radius:18px;background:var(--sf);color:var(--txd);cursor:pointer;transition:.15s;user-select:none;white-space:nowrap}
.ft:hover{border-color:var(--txd)}.ft.on{background:var(--tx);color:#fff;border-color:var(--tx)}
.rb{font-family:'JetBrains Mono',monospace;font-size:10px;padding:5px 14px;border:1px solid var(--ac);border-radius:5px;background:var(--sf);color:var(--ac);cursor:pointer;white-space:nowrap}
.rb:hover{background:var(--ac);color:#fff}.rb:disabled{opacity:.35;cursor:not-allowed}
.dl{font-family:'Cormorant Garamond',serif;font-size:17px;font-weight:600;margin:24px 0 10px;padding-bottom:5px;border-bottom:1px solid var(--bd)}
.cd{display:block;text-decoration:none;color:inherit;background:var(--sf);border:1px solid var(--bd);border-radius:8px;padding:14px 16px;margin-bottom:7px;transition:.2s}
.cd:hover{box-shadow:0 3px 16px rgba(0,0,0,.06);transform:translateY(-1px)}
.cd:active{transform:scale(.998)}
.bg{display:inline-block;font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:500;text-transform:uppercase;letter-spacing:1.5px;padding:2px 7px;border-radius:3px;margin-bottom:5px}
.bg-cc{background:#fef3c7;color:#92400e}.bg-pm{background:#fae8ff;color:#7e22ce}.bg-oa{background:#ccfbf1;color:#0f766e}
.bg-lancet{background:#fee2e2;color:#991b1b}.bg-nejm{background:#dbeafe;color:#1e40af}.bg-jcla{background:#e0e7ff;color:#3730a3}
.ct{font-family:'Cormorant Garamond','Noto Sans SC',serif;font-size:16px;font-weight:600;line-height:1.45;margin-bottom:3px}
.ca{font-size:11px;color:var(--txd);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cab{font-size:12px;color:var(--txl);line-height:1.6;margin-top:4px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.cf{display:flex;gap:10px;margin-top:5px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--txl);flex-wrap:wrap}
.papers{padding-bottom:70px}
.la{text-align:center;padding:50px 16px}.la .dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--ac);margin:0 3px;animation:bo 1s ease-in-out infinite}
.la .dot:nth-child(2){animation-delay:.12s}.la .dot:nth-child(3){animation-delay:.24s}
@keyframes bo{0%,80%,100%{transform:scale(.5);opacity:.3}40%{transform:scale(1);opacity:1}}
.la .lt{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--txl);margin-top:12px}
.logwrap{margin:10px 0}
.logbtn{font-family:'JetBrains Mono',monospace;font-size:10px;padding:3px 10px;border:1px solid var(--bd);border-radius:5px;background:var(--sf);color:var(--txl);cursor:pointer}
.logbox{margin-top:6px;padding:10px;background:#1e1e2e;border-radius:7px;max-height:160px;overflow:auto;font-family:'JetBrains Mono',monospace;font-size:10px;line-height:1.5;color:#cdd6f4;display:none}
.logbox.open{display:block}
.logbox .err{color:#f38ba8}.logbox .ok{color:#a6e3a1}.logbox .wrn{color:#f9e2af}
.empty{text-align:center;padding:50px 16px;color:var(--txl);font-family:'JetBrains Mono',monospace;font-size:12px}
@media(max-width:500px){.ct{font-size:15px}.cd{padding:12px 14px}.ctl{flex-direction:column;align-items:flex-start}}
</style>
</head>
<body>
<div class="hd">
  <h1>LabMed Daily</h1>
  <div class="sub">Ê£ÄÈ™åÂåªÂ≠¶ËÆ∫ÊñáÊó•Êä•</div>
  <div class="date" id="dt"></div>
  <div class="meta"><span><b id="tc">0</b> ÁØáËÆ∫Êñá</span><span><b id="sc">0</b> Êù•Ê∫ê</span></div>
</div>
<div class="bar load" id="bar"><div class="pbar"><div class="pfill" id="pfill" style="width:0%"></div></div><span id="bartxt">Ê≠£Âú®Ëé∑ÂèñËÆ∫Êñá...</span></div>
<div class="wrap">
  <div class="ctl">
    <div class="fg" id="fg"></div>
    <button class="rb" id="rbtn" onclick="loadAll()" disabled>‚ü≥ Âà∑Êñ∞</button>
  </div>
  <div class="logwrap">
    <button class="logbtn" onclick="toggleLog()"><span id="la">‚ñ∂</span> Ë∞ÉËØïÊó•Âøó (<span id="lc">0</span>)</button>
    <div class="logbox" id="logbox"></div>
  </div>
  <div class="papers" id="pa"></div>
</div>
<script>
// =============================================
// LabMed Daily v6 ‚Äî 6 Êù•Ê∫êÂÆûÊó∂Ëé∑Âèñ
// ÈÉ®ÁΩ≤: index.html ‚Üí GitHub Pages
// =============================================

// --- Êù•Ê∫êÂÆö‰πâ ---
const SOURCES = [
  {id:'cc',   name:'Clinical Chemistry', bg:'bg-cc'},
  {id:'lancet',name:'The Lancet',        bg:'bg-lancet'},
  {id:'nejm', name:'NEJM',              bg:'bg-nejm'},
  {id:'jcla', name:'J Clin Lab Anal',   bg:'bg-jcla'},
  {id:'pm',   name:'PubMed',            bg:'bg-pm'},
  {id:'oa',   name:'OpenAlex',          bg:'bg-oa'},
];
const BDGMAP={}; SOURCES.forEach(s=>BDGMAP[s.id]=s);

// --- Êó•Âøó ---
let logs=[];
function log(m){logs.push(m);document.getElementById('lc').textContent=logs.length;const b=document.getElementById('logbox'),c=m.includes('‚ùå')?'err':m.includes('‚úÖ')?'ok':m.includes('‚ö†')?'wrn':'';b.innerHTML+=`<div class="${c}">${new Date().toLocaleTimeString()} ${m}</div>`;b.scrollTop=b.scrollHeight;}
function toggleLog(){const b=document.getElementById('logbox');b.classList.toggle('open');document.getElementById('la').textContent=b.classList.contains('open')?'‚ñº':'‚ñ∂';}

// --- ÂÆâÂÖ® fetch ---
function sF(url,ms=15000){const c=new AbortController(),t=setTimeout(()=>c.abort(),ms);return fetch(url,{signal:c.signal}).then(r=>{clearTimeout(t);return r}).catch(e=>{clearTimeout(t);throw e})}

// --- CORS ‰ª£ÁêÜ (Áî®‰∫é RSS feeds) ---
const PX=[
  u=>'https://api.allorigins.win/raw?url='+encodeURIComponent(u),
  u=>'https://corsproxy.io/?'+encodeURIComponent(u),
  u=>'https://api.codetabs.com/v1/proxy?quest='+encodeURIComponent(u),
];
async function viaProxy(url){
  for(let i=0;i<PX.length;i++){
    const n=['allorigins','corsproxy','codetabs'][i];
    try{log('üîÑ '+n+'...');const r=await sF(PX[i](url),12000);if(r.ok){const t=await r.text();if(t.length>100){log('‚úÖ '+n+' ('+t.length+'B)');return t}}log('‚ö†Ô∏è '+n+' Êó†Êïà')}catch(e){log('‚ùå '+n+': '+e.message)}
  }
  return null;
}

// --- RSS Ëß£ÊûêÈÄöÁî®ÂáΩÊï∞ ---
function stripH(s){if(!s)return'';const d=document.createElement('div');d.innerHTML=s;return d.textContent.replace(/\s+/g,' ').trim()}

function parseRSS(xml, sid, srcName, journalName){
  const ps=[], doc=new DOMParser().parseFromString(xml,'text/xml');
  if(doc.querySelector('parsererror'))return ps;
  doc.querySelectorAll('item').forEach(it=>{
    const title=(it.querySelector('title')?.textContent||'').trim();
    let link=(it.querySelector('link')?.textContent||'').trim().replace('?rss=1','');
    const pub=it.querySelector('pubDate')?.textContent||'';
    const desc=it.querySelector('description')?.textContent||'';
    // Â∞ùËØïËé∑Âèñ dc:creator ‰ΩúËÄÖ
    const creator=it.getElementsByTagNameNS('http://purl.org/dc/elements/1.1/','creator')[0]?.textContent||'';
    if(!title||title.length<10)return;
    let date='';try{date=new Date(pub).toISOString().slice(0,10)}catch{}
    let ab=stripH(desc);if(ab.length>400)ab=ab.slice(0,400)+'...';
    ps.push({sid,s:srcName,title,url:link,authors:creator,date,journal:journalName,abstract:ab});
  });
  return ps;
}

// --- RSS Êù•Ê∫ê ---
const RSS_FEEDS = [
  // Clinical Chemistry
  {sid:'cc', name:'Clinical Chemistry', journal:'Clinical Chemistry (Advance)',
   url:'https://academic.oup.com/rss/site_6246/advanceAccess_4044.xml'},
  {sid:'cc', name:'Clinical Chemistry', journal:'Clinical Chemistry (Current)',
   url:'https://academic.oup.com/rss/site_6246/4044.xml'},
  // The Lancet
  {sid:'lancet', name:'The Lancet', journal:'The Lancet',
   url:'https://www.thelancet.com/rssfeed/lancet_online.xml'},
  // NEJM
  {sid:'nejm', name:'NEJM', journal:'N Engl J Med',
   url:'https://www.nejm.org/action/showFeed?jc=nejm&type=etoc&feed=rss'},
  // J Clinical Laboratory Analysis (Wiley)
  {sid:'jcla', name:'J Clin Lab Anal', journal:'J Clin Lab Anal',
   url:'https://onlinelibrary.wiley.com/feed/10982825/most-recent'},
];

async function fetchAllRSS(){
  const all=[], seen=new Set();
  for(const feed of RSS_FEEDS){
    log('üì° Ëé∑Âèñ '+feed.journal+'...');
    const xml=await viaProxy(feed.url);
    if(!xml||(!xml.includes('<item')&&!xml.includes('<entry'))){
      log('‚ö†Ô∏è '+feed.journal+': Êó†ÊúâÊïà RSS');continue;
    }
    const ps=parseRSS(xml, feed.sid, feed.name, feed.journal);
    let cnt=0;
    for(const p of ps){
      const k=p.title.toLowerCase().replace(/[^a-z0-9]/g,'').slice(0,60);
      if(!seen.has(k)){seen.add(k);all.push(p);cnt++}
    }
    log('‚úÖ '+feed.journal+': '+cnt+' ÁØá');
  }
  return all;
}

// --- PubMed API (CORS ‚úì) ---
const LMQ=['clinical laboratory medicine','clinical chemistry biomarker','hematology laboratory testing','molecular diagnostics pathology','immunoassay clinical','point-of-care testing','flow cytometry clinical','mass spectrometry clinical laboratory','tumor marker diagnostics'];
function pickQ(n){return[...LMQ].sort(()=>Math.random()-.5).slice(0,n)}

async function fetchPubMed(q){
  log('üîç PubMed: '+q);
  try{
    const sr=await sF('https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&term='+encodeURIComponent(q)+'&retmax=5&sort=date&retmode=json',10000);
    if(!sr.ok){log('‚ùå PubMed HTTP '+sr.status);return[]}
    const sd=await sr.json(),ids=sd.esearchresult?.idlist||[];
    if(!ids.length){log('‚ö†Ô∏è PubMed: 0 Êù°');return[]}
    const sm=await sF('https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&id='+ids.join(',')+'&retmode=json',10000);
    if(!sm.ok)return[];
    const d=await sm.json();
    const ps=ids.map(id=>{const it=d.result?.[id];if(!it)return null;return{sid:'pm',s:'PubMed',title:it.title||'',authors:(it.authors||[]).map(a=>a.name).join(', '),date:it.pubdate||'',url:'https://pubmed.ncbi.nlm.nih.gov/'+id+'/',journal:it.source||'',abstract:''}}).filter(Boolean);
    log('‚úÖ PubMed "'+q+'": '+ps.length+'ÁØá');return ps;
  }catch(e){log('‚ùå PubMed: '+e.message);return[]}
}

// --- OpenAlex API (CORS ‚úì) ---
async function fetchOA(q){
  log('üîç OpenAlex: '+q);
  try{
    const r=await sF('https://api.openalex.org/works?search='+encodeURIComponent(q)+'&per_page=5&sort=publication_date:desc&filter=type:article&mailto=labmed@example.com',10000);
    if(!r.ok){log('‚ùå OpenAlex HTTP '+r.status);return[]}
    const d=await r.json();
    return(d.results||[]).map(w=>{let ab='';if(w.abstract_inverted_index){const ws=[];for(const[word,pos]of Object.entries(w.abstract_inverted_index))for(const p of pos)ws[p]=word;ab=ws.join(' ')}
      return{sid:'oa',s:'OpenAlex',title:w.title||'',authors:(w.authorships||[]).map(a=>a.author?.display_name).filter(Boolean).join(', '),date:w.publication_date||'',url:w.doi||w.id||'',journal:w.primary_location?.source?.display_name||'',abstract:ab}});
  }catch(e){log('‚ùå OpenAlex: '+e.message);return[]}
}

// --- ‰∏ªÈÄªËæë ---
let allPapers=[], af='all';

async function loadAll(){
  const btn=document.getElementById('rbtn');btn.disabled=true;btn.textContent='Âä†ËΩΩ‰∏≠...';
  allPapers=[];logs=[];document.getElementById('logbox').innerHTML='';document.getElementById('lc').textContent='0';
  setBar('load','Ê≠£Âú®Ëé∑ÂèñËÆ∫Êñá...',0);showLD();
  const qs=pickQ(2);
  log('üöÄ ÂÖ≥ÈîÆËØç: '+qs.join(', '));

  // ÊÄªÊ≠•Êï∞: RSS feeds(1Êâπ) + PubMed*qs + OpenAlex*qs
  const steps=1+qs.length*2;let done=0;
  const prog=()=>{done++;document.getElementById('pfill').style.width=Math.round(done/steps*100)+'%'};

  // 1. ÊâÄÊúâ RSS (Clinical Chemistry + Lancet + NEJM + JCLA)
  const rss=await fetchAllRSS();allPapers.push(...rss);prog();renderP();

  // 2. PubMed
  for(const q of qs){const pm=await fetchPubMed(q);allPapers.push(...pm);prog();renderP();await new Promise(r=>setTimeout(r,350))}

  // 3. OpenAlex
  for(const q of qs){const oa=await fetchOA(q);allPapers.push(...oa);prog();renderP();await new Promise(r=>setTimeout(r,350))}

  const u=getU('all');
  log('üèÅ ÂÆåÊàêÔºÅÂÖ± '+u.length+' ÁØá');
  if(u.length>0)setBar('ok','‚úÖ ÂÖ± '+u.length+' ÁØáËÆ∫Êñá ¬∑ '+new Date().toLocaleTimeString('zh-CN'),100);
  else{setBar('warn','‚ö†Ô∏è Êú™Ëé∑ÂèñÂà∞ËÆ∫ÊñáÔºåÊü•ÁúãÊó•Âøó',100);document.getElementById('logbox').classList.add('open');document.getElementById('la').textContent='‚ñº'}
  btn.disabled=false;btn.textContent='‚ü≥ Âà∑Êñ∞';renderF();renderSt();
}

function setBar(c,t,p){document.getElementById('bar').className='bar '+c;document.getElementById('bartxt').textContent=t;if(p!==undefined)document.getElementById('pfill').style.width=p+'%'}

function getU(f){const seen=new Map();for(const p of allPapers){const k=p.title.toLowerCase().replace(/[^a-z0-9\u4e00-\u9fff]/g,'').slice(0,80);if(k.length>=5&&!seen.has(k))seen.set(k,p)}let ps=[...seen.values()];if(f&&f!=='all')ps=ps.filter(p=>p.sid===f);ps.sort((a,b)=>(b.date||'0').localeCompare(a.date||'0'));return ps}

function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}

function fmtD(d){if(!d||d==='Êú™Áü•Êó•Êúü')return d||'';try{const dt=new Date(d),t=new Date();t.setHours(0,0,0,0);const diff=Math.floor((t-dt)/864e5);if(diff===0)return'‰ªäÂ§© ¬∑ '+d;if(diff===1)return'Êò®Â§© ¬∑ '+d;if(diff<7)return diff+'Â§©Ââç ¬∑ '+d;return d}catch{return d}}

function renderP(){
  const ps=getU(af),area=document.getElementById('pa');
  if(!ps.length){area.innerHTML='<div class="empty">ÊöÇÊó†ËÆ∫Êñá</div>';return}
  const g=new Map();for(const p of ps){const d=p.date?.slice(0,10)||'Êú™Áü•Êó•Êúü';if(!g.has(d))g.set(d,[]);g.get(d).push(p)}
  let h='';for(const[date,list]of g){
    h+='<div class="dl">'+fmtD(date)+'</div>';
    for(const p of list){const b=BDGMAP[p.sid]||BDGMAP.cc;
      h+='<a class="cd" href="'+esc(p.url||'#')+'" target="_blank" rel="noopener"><span class="bg '+b.bg+'">'+esc(p.s)+'</span><div class="ct">'+esc(p.title)+'</div>'+(p.authors?'<div class="ca">'+esc(p.authors)+'</div>':'')+(p.abstract?'<div class="cab">'+esc(p.abstract)+'</div>':'')+'<div class="cf">'+(p.journal?'<span>üìñ '+esc(p.journal)+'</span>':'')+(p.date?'<span>üìÖ '+esc(p.date)+'</span>':'')+'</div></a>';
    }
  }area.innerHTML=h;
}

function renderF(){
  const all=getU('all'),counts={};all.forEach(p=>counts[p.sid]=(counts[p.sid]||0)+1);
  let h='<span class="ft'+(af==='all'?' on':'')+'" onclick="setF(\'all\')">ÂÖ®ÈÉ® ('+all.length+')</span>';
  SOURCES.forEach(s=>{const n=counts[s.id]||0;if(!n)return;h+='<span class="ft'+(af===s.id?' on':'')+'" onclick="setF(\''+s.id+'\')">'+s.name+' ('+n+')</span>'});
  document.getElementById('fg').innerHTML=h;
}
function setF(f){af=f;renderF();renderP()}

function renderSt(){const u=getU('all');document.getElementById('tc').textContent=u.length;document.getElementById('sc').textContent=new Set(u.map(p=>p.sid)).size}

function showLD(){document.getElementById('pa').innerHTML='<div class="la"><span class="dot"></span><span class="dot"></span><span class="dot"></span><div class="lt">Ê≠£Âú®‰ªé 6 ‰∏™Êù•Ê∫êËé∑ÂèñËÆ∫Êñá...</div></div>'}

document.getElementById('dt').textContent=new Date().toLocaleDateString('zh-CN',{year:'numeric',month:'long',day:'numeric',weekday:'long'});
loadAll();
</script>
</body>
</html>
